# Fluent i18n Integration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Integrate fluentogram-based internationalization for English and Russian support with Telegram language detection.

**Architecture:** Create `src/infrastructure/i18n/` module with TranslatorHub factory and Dishka provider. Locale files organized by feature in `locales/{lang}/*.ftl`. Handlers inject TranslatorHub and resolve translator from Telegram's language_code.

**Tech Stack:** fluentogram, fluent-compiler, Dishka DI, aiogram

---

## Task 1: Add Dependencies

**Files:**
- Modify: `pyproject.toml`

**Step 1: Add fluentogram and fluent-compiler to dependencies**

In `pyproject.toml`, add to the `dependencies` list:

```toml
"fluentogram>=0.4.0",
"fluent-compiler>=0.4.0",
```

**Step 2: Install dependencies**

Run: `uv sync`
Expected: Dependencies installed successfully

**Step 3: Commit**

```bash
git add pyproject.toml uv.lock
git commit -m "chore: add fluentogram and fluent-compiler dependencies"
```

---

## Task 2: Create Locale Files (English)

**Files:**
- Create: `locales/en/common.ftl`
- Create: `locales/en/start.ftl`
- Create: `locales/en/admin.ftl`

**Step 1: Create directory structure**

Run: `mkdir -p locales/en locales/ru`

**Step 2: Create locales/en/common.ftl**

```ftl
# Common strings shared across features
# Reserved for future buttons, errors, etc.
```

**Step 3: Create locales/en/start.ftl**

```ftl
# Start command messages
welcome = Hello, { $name }!
```

**Step 4: Create locales/en/admin.ftl**

```ftl
# Admin-only messages
example-executed = Example admin command executed
bot-started = Bot has started!
```

**Step 5: Commit**

```bash
git add locales/
git commit -m "feat(i18n): add English locale files"
```

---

## Task 3: Create Locale Files (Russian)

**Files:**
- Create: `locales/ru/common.ftl`
- Create: `locales/ru/start.ftl`
- Create: `locales/ru/admin.ftl`

**Step 1: Create locales/ru/common.ftl**

```ftl
# Общие строки
# Зарезервировано для кнопок, ошибок и т.д.
```

**Step 2: Create locales/ru/start.ftl**

```ftl
# Сообщения команды /start
welcome = Привет, { $name }!
```

**Step 3: Create locales/ru/admin.ftl**

```ftl
# Сообщения для администраторов
example-executed = Пример админской команды выполнен
bot-started = Бот запущен!
```

**Step 4: Commit**

```bash
git add locales/
git commit -m "feat(i18n): add Russian locale files"
```

---

## Task 4: Create i18n Hub Module

**Files:**
- Create: `src/infrastructure/i18n/__init__.py`
- Create: `src/infrastructure/i18n/hub.py`
- Test: `tests/unit/infrastructure/i18n/test_hub.py`

**Step 1: Create directory**

Run: `mkdir -p src/infrastructure/i18n tests/unit/infrastructure/i18n`

**Step 2: Write the failing test**

Create `tests/unit/infrastructure/i18n/__init__.py`:
```python
```

Create `tests/unit/infrastructure/i18n/test_hub.py`:

```python
from pathlib import Path

import pytest


class TestTranslatorHub:
    def test_create_translator_hub_loads_languages(self) -> None:
        from src.infrastructure.i18n.hub import SUPPORTED_LANGUAGES, create_translator_hub

        locales_dir = Path(__file__).parent.parent.parent.parent.parent / "locales"
        hub = create_translator_hub(locales_dir)

        # Should be able to get translators for all supported languages
        for lang in SUPPORTED_LANGUAGES:
            translator = hub.get_translator_by_locale(lang)
            assert translator is not None

    def test_default_language_is_english(self) -> None:
        from src.infrastructure.i18n.hub import DEFAULT_LANGUAGE

        assert DEFAULT_LANGUAGE == "en"

    def test_supported_languages_contains_en_and_ru(self) -> None:
        from src.infrastructure.i18n.hub import SUPPORTED_LANGUAGES

        assert "en" in SUPPORTED_LANGUAGES
        assert "ru" in SUPPORTED_LANGUAGES

    def test_translator_returns_translated_string(self) -> None:
        from src.infrastructure.i18n.hub import create_translator_hub

        locales_dir = Path(__file__).parent.parent.parent.parent.parent / "locales"
        hub = create_translator_hub(locales_dir)

        en_translator = hub.get_translator_by_locale("en")
        result = en_translator.get("welcome", name="Test")
        assert result == "Hello, Test!"

    def test_russian_translator_returns_russian_string(self) -> None:
        from src.infrastructure.i18n.hub import create_translator_hub

        locales_dir = Path(__file__).parent.parent.parent.parent.parent / "locales"
        hub = create_translator_hub(locales_dir)

        ru_translator = hub.get_translator_by_locale("ru")
        result = ru_translator.get("welcome", name="Тест")
        assert result == "Привет, Тест!"
```

**Step 3: Run test to verify it fails**

Run: `pytest tests/unit/infrastructure/i18n/test_hub.py -v --no-cov`
Expected: FAIL with "ModuleNotFoundError: No module named 'src.infrastructure.i18n'"

**Step 4: Write the implementation**

Create `src/infrastructure/i18n/hub.py`:

```python
"""TranslatorHub factory and utilities for i18n."""

from pathlib import Path

from fluent_compiler.bundle import FluentBundle
from fluentogram import FluentTranslator, TranslatorHub

SUPPORTED_LANGUAGES = ("en", "ru")
DEFAULT_LANGUAGE = "en"


def load_ftl_files(locale_dir: Path, language: str) -> str:
    """Load and concatenate all .ftl files for a language."""
    lang_dir = locale_dir / language
    if not lang_dir.exists():
        return ""

    ftl_content = []
    for ftl_file in sorted(lang_dir.glob("*.ftl")):
        ftl_content.append(ftl_file.read_text(encoding="utf-8"))

    return "\n\n".join(ftl_content)


def create_translator_hub(locale_dir: Path | None = None) -> TranslatorHub:
    """Create and configure the TranslatorHub with all supported languages.

    Args:
        locale_dir: Path to locales directory. Defaults to project root /locales.

    Returns:
        Configured TranslatorHub instance.
    """
    if locale_dir is None:
        locale_dir = Path(__file__).parent.parent.parent.parent / "locales"

    translators = []

    for lang in SUPPORTED_LANGUAGES:
        ftl_content = load_ftl_files(locale_dir, lang)
        if ftl_content:
            bundle = FluentBundle.from_string(lang, ftl_content)
            translators.append(FluentTranslator(lang, translator=bundle))

    # Configure locale mapping with English as fallback
    locale_map = {
        "en": ("en",),
        "ru": ("ru", "en"),
    }

    return TranslatorHub(locale_map, translators, root_locale="en")
```

Create `src/infrastructure/i18n/__init__.py`:

```python
"""Internationalization (i18n) infrastructure module."""

from .hub import (
    DEFAULT_LANGUAGE,
    SUPPORTED_LANGUAGES,
    create_translator_hub,
)

__all__ = [
    "DEFAULT_LANGUAGE",
    "SUPPORTED_LANGUAGES",
    "create_translator_hub",
]
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/unit/infrastructure/i18n/test_hub.py -v --no-cov`
Expected: PASS (5 tests)

**Step 6: Commit**

```bash
git add src/infrastructure/i18n/ tests/unit/infrastructure/i18n/
git commit -m "feat(i18n): add TranslatorHub factory module"
```

---

## Task 5: Create Dishka i18n Provider

**Files:**
- Create: `src/infrastructure/i18n/provider.py`
- Modify: `src/infrastructure/i18n/__init__.py`
- Test: `tests/unit/infrastructure/i18n/test_provider.py`

**Step 1: Write the failing test**

Create `tests/unit/infrastructure/i18n/test_provider.py`:

```python
from pathlib import Path

from dishka import make_async_container
from fluentogram import TranslatorHub
import pytest


class TestI18nProvider:
    @pytest.fixture
    def locale_dir(self) -> Path:
        return Path(__file__).parent.parent.parent.parent.parent / "locales"

    async def test_provider_provides_translator_hub(self, locale_dir: Path) -> None:
        from src.infrastructure.i18n import I18nProvider

        container = make_async_container(I18nProvider(locale_dir=locale_dir))

        async with container() as request_container:
            hub = await request_container.get(TranslatorHub)
            assert hub is not None
            assert isinstance(hub, TranslatorHub)

    async def test_provider_hub_is_singleton(self, locale_dir: Path) -> None:
        from src.infrastructure.i18n import I18nProvider

        container = make_async_container(I18nProvider(locale_dir=locale_dir))

        async with container() as request_container:
            hub1 = await request_container.get(TranslatorHub)
            hub2 = await request_container.get(TranslatorHub)
            assert hub1 is hub2
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/unit/infrastructure/i18n/test_provider.py -v --no-cov`
Expected: FAIL with "ImportError: cannot import name 'I18nProvider'"

**Step 3: Write the implementation**

Create `src/infrastructure/i18n/provider.py`:

```python
"""Dishka provider for internationalization."""

from pathlib import Path

from dishka import Provider, Scope, provide
from fluentogram import TranslatorHub

from .hub import create_translator_hub


class I18nProvider(Provider):
    """Dishka provider for internationalization.

    Provides TranslatorHub as an app-scoped singleton.
    """

    scope = Scope.APP

    def __init__(self, locale_dir: Path | None = None) -> None:
        """Initialize the i18n provider.

        Args:
            locale_dir: Path to locales directory. Defaults to project root /locales.
        """
        self.locale_dir = locale_dir
        super().__init__()

    @provide(scope=Scope.APP)
    def get_translator_hub(self) -> TranslatorHub:
        """Provide TranslatorHub as app-scoped singleton."""
        return create_translator_hub(self.locale_dir)
```

**Step 4: Update src/infrastructure/i18n/__init__.py**

```python
"""Internationalization (i18n) infrastructure module."""

from .hub import (
    DEFAULT_LANGUAGE,
    SUPPORTED_LANGUAGES,
    create_translator_hub,
)
from .provider import I18nProvider

__all__ = [
    "DEFAULT_LANGUAGE",
    "SUPPORTED_LANGUAGES",
    "I18nProvider",
    "create_translator_hub",
]
```

**Step 5: Run test to verify it passes**

Run: `pytest tests/unit/infrastructure/i18n/test_provider.py -v --no-cov`
Expected: PASS (2 tests)

**Step 6: Commit**

```bash
git add src/infrastructure/i18n/
git commit -m "feat(i18n): add Dishka I18nProvider"
```

---

## Task 6: Create Stub Generator Script

**Files:**
- Create: `scripts/generate_i18n_stubs.py`

**Step 1: Create scripts directory**

Run: `mkdir -p scripts`

**Step 2: Create the stub generator script**

Create `scripts/generate_i18n_stubs.py`:

```python
#!/usr/bin/env python3
"""Generate Python type stubs for fluentogram translations.

This script parses .ftl files and generates a .pyi stub file
that provides IDE autocomplete for translation keys.
"""

import re
from pathlib import Path


def extract_ftl_keys(ftl_content: str) -> list[tuple[str, list[str]]]:
    """Extract translation keys and their parameters from FTL content.

    Returns list of (key_name, [param_names]).
    """
    keys = []
    lines = ftl_content.split("\n")

    i = 0
    while i < len(lines):
        line = lines[i]

        # Skip comments and empty lines
        if not line.strip() or line.strip().startswith("#"):
            i += 1
            continue

        # Match key = value pattern
        match = re.match(r"^([a-z][a-z0-9_-]*)\s*=\s*(.*)", line)
        if match:
            key = match.group(1)
            value_lines = [match.group(2)]

            # Collect multiline values
            i += 1
            while i < len(lines):
                next_line = lines[i]
                if next_line.startswith(("    ", "\t")) or (
                    not next_line.strip()
                    and i + 1 < len(lines)
                    and lines[i + 1].startswith(("    ", "\t"))
                ):
                    value_lines.append(next_line)
                    i += 1
                else:
                    break

            value = "\n".join(value_lines)

            # Extract parameters like { $param_name }
            params = re.findall(r"\{\s*\$([a-z_][a-z0-9_]*)\s*\}", value, re.IGNORECASE)
            # Remove duplicates while preserving order
            seen = set()
            unique_params = []
            for p in params:
                if p not in seen:
                    seen.add(p)
                    unique_params.append(p)

            keys.append((key, unique_params))
        else:
            i += 1

    return keys


def generate_stub_content(all_keys: dict[str, list[str]]) -> str:
    """Generate .pyi stub content for FluentTranslator."""
    lines = [
        '"""Auto-generated type stubs for fluentogram translations.',
        "",
        "Generated by scripts/generate_i18n_stubs.py",
        "Do not edit manually - regenerate with: python scripts/generate_i18n_stubs.py",
        '"""',
        "",
        "",
        "class TranslatorRunner:",
        '    """Type stubs for FluentTranslator with all available translation keys."""',
        "",
    ]

    for key, params in sorted(all_keys.items()):
        # Convert kebab-case to snake_case for method name
        method_name = key.replace("-", "_")
        if params:
            param_str = ", ".join(f"{p}: str | int" for p in params)
            lines.append(f"    def {method_name}(self, *, {param_str}) -> str: ...")
        else:
            lines.append(f"    def {method_name}(self) -> str: ...")

    lines.append("")
    return "\n".join(lines)


def main() -> None:
    """Generate stubs from locale files."""
    project_root = Path(__file__).parent.parent
    locales_dir = project_root / "locales"
    output_file = project_root / "src" / "infrastructure" / "i18n" / "stubs.pyi"

    # Use English as the reference locale
    en_dir = locales_dir / "en"

    if not en_dir.exists():
        print(f"Error: English locale directory not found: {en_dir}")
        return

    all_keys: dict[str, list[str]] = {}

    # Parse all .ftl files in the English locale
    for ftl_file in en_dir.glob("*.ftl"):
        content = ftl_file.read_text()
        keys = extract_ftl_keys(content)
        for key, params in keys:
            all_keys[key] = params
        print(f"Parsed {ftl_file.name}: {len(keys)} keys")

    if not all_keys:
        print("Error: No translation keys found")
        return

    # Generate stub content
    stub_content = generate_stub_content(all_keys)

    # Write stub file
    output_file.parent.mkdir(parents=True, exist_ok=True)
    output_file.write_text(stub_content)
    print(f"\nGenerated {output_file} with {len(all_keys)} translation methods")


if __name__ == "__main__":
    main()
```

**Step 3: Run the script to generate stubs**

Run: `python scripts/generate_i18n_stubs.py`
Expected output:
```
Parsed admin.ftl: 2 keys
Parsed common.ftl: 0 keys
Parsed start.ftl: 1 keys

Generated src/infrastructure/i18n/stubs.pyi with 3 translation methods
```

**Step 4: Verify generated stubs.pyi**

The file `src/infrastructure/i18n/stubs.pyi` should contain:

```python
"""Auto-generated type stubs for fluentogram translations.

Generated by scripts/generate_i18n_stubs.py
Do not edit manually - regenerate with: python scripts/generate_i18n_stubs.py
"""


class TranslatorRunner:
    """Type stubs for FluentTranslator with all available translation keys."""

    def bot_started(self) -> str: ...
    def example_executed(self) -> str: ...
    def welcome(self, *, name: str | int) -> str: ...
```

**Step 5: Commit**

```bash
git add scripts/generate_i18n_stubs.py src/infrastructure/i18n/stubs.pyi
git commit -m "feat(i18n): add stub generator script and generated stubs"
```

---

## Task 7: Register I18nProvider in DI

**Files:**
- Modify: `src/infrastructure/di/__init__.py`

**Step 1: Read current file**

Current content of `src/infrastructure/di/__init__.py`:

```python
from .auth import AuthProvider
from .db import DBProvider
from .interactors import AuthInteractorProvider, interactor_providers

infra_providers = [
    AuthProvider,
    AuthInteractorProvider,
]

__all__ = [
    "DBProvider",
    "infra_providers",
    "interactor_providers",
]
```

**Step 2: Update to include I18nProvider**

```python
from .auth import AuthProvider
from .db import DBProvider
from .interactors import AuthInteractorProvider, interactor_providers

from src.infrastructure.i18n import I18nProvider

infra_providers = [
    AuthProvider,
    AuthInteractorProvider,
]

__all__ = [
    "DBProvider",
    "I18nProvider",
    "infra_providers",
    "interactor_providers",
]
```

**Step 3: Run linter**

Run: `ruff check src/infrastructure/di/__init__.py --fix`
Expected: No errors

**Step 4: Commit**

```bash
git add src/infrastructure/di/__init__.py
git commit -m "feat(i18n): export I18nProvider from DI module"
```

---

## Task 8: Update Bot Main to Use I18nProvider

**Files:**
- Modify: `src/presentation/bot/main.py`
- Test: Manual verification (bot startup)

**Step 1: Read current file**

Current `src/presentation/bot/main.py` has:
- `notify_admins_on_startup(bot, config)` with hardcoded "Bot has started!"
- `make_async_container(...)` without I18nProvider

**Step 2: Update main.py**

```python
import asyncio
import logging
import sys

from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.exceptions import TelegramAPIError
from dishka import make_async_container
from dishka.integrations.aiogram import setup_dishka
from fluentogram import TranslatorHub

from src.infrastructure.config import Config, load_config
from src.infrastructure.di import AuthProvider, DBProvider, I18nProvider, interactor_providers
from src.infrastructure.i18n import DEFAULT_LANGUAGE
from src.presentation.bot.routers import setup_routers


async def notify_admins_on_startup(bot: Bot, config: Config, hub: TranslatorHub) -> None:
    """Send notification to admins when bot starts up."""
    i18n = hub.get_translator_by_locale(DEFAULT_LANGUAGE)
    for admin_id in config.telegram.admin_ids:
        try:
            await bot.send_message(chat_id=admin_id, text=i18n.get("bot-started"))
        except TelegramAPIError as e:
            logging.warning("Failed to notify admin %s: %s", admin_id, e)


async def main() -> None:
    config = load_config()
    bot = Bot(
        token=config.telegram.bot_token,
        default=DefaultBotProperties(parse_mode=ParseMode.HTML),
    )

    interactor_provider_instances = [
        interactor() for interactor in interactor_providers
    ]

    dp = Dispatcher()
    main_router = setup_routers()
    dp.include_router(main_router)

    container = make_async_container(
        AuthProvider(),
        DBProvider(config.postgres),
        I18nProvider(),
        *interactor_provider_instances,
        context={Config: config},
    )
    setup_dishka(container=container, router=dp)

    # Get TranslatorHub for admin notification
    async with container() as request_container:
        hub = await request_container.get(TranslatorHub)
        await notify_admins_on_startup(bot, config, hub)

    await dp.start_polling(bot, config=config)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, stream=sys.stdout)
    asyncio.run(main())
```

**Step 3: Run linter**

Run: `ruff check src/presentation/bot/main.py --fix`
Expected: No errors

**Step 4: Commit**

```bash
git add src/presentation/bot/main.py
git commit -m "feat(i18n): integrate I18nProvider in bot startup"
```

---

## Task 9: Update /start Handler to Use i18n

**Files:**
- Modify: `src/presentation/bot/routers/commands.py`
- Test: `tests/unit/presentation/bot/routers/test_commands.py`

**Step 1: Write the failing test**

Create `tests/unit/presentation/bot/routers/__init__.py`:
```python
```

Create `tests/unit/presentation/bot/routers/test_commands.py`:

```python
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock

import pytest
from aiogram.types import Message, User
from fluentogram import TranslatorHub

from src.infrastructure.i18n import create_translator_hub


class TestCommandStartHandler:
    @pytest.fixture
    def hub(self) -> TranslatorHub:
        locales_dir = Path(__file__).parent.parent.parent.parent.parent / "locales"
        return create_translator_hub(locales_dir)

    @pytest.fixture
    def mock_message(self) -> MagicMock:
        message = MagicMock(spec=Message)
        message.from_user = MagicMock(spec=User)
        message.from_user.id = 123456
        message.from_user.username = "testuser"
        message.from_user.first_name = "John"
        message.from_user.last_name = "Doe"
        message.from_user.is_premium = False
        message.from_user.language_code = "en"
        message.answer = AsyncMock()
        return message

    async def test_start_handler_uses_english_for_en_user(
        self, mock_message: MagicMock, hub: TranslatorHub
    ) -> None:
        from src.presentation.bot.routers.commands import command_start_handler

        mock_interactor = AsyncMock()
        mock_interactor.return_value = MagicMock(first_name="John")

        await command_start_handler(
            message=mock_message,
            interactor=mock_interactor,
            hub=hub,
        )

        mock_message.answer.assert_called_once()
        call_args = mock_message.answer.call_args
        assert call_args.kwargs["text"] == "Hello, John!"

    async def test_start_handler_uses_russian_for_ru_user(
        self, mock_message: MagicMock, hub: TranslatorHub
    ) -> None:
        from src.presentation.bot.routers.commands import command_start_handler

        mock_message.from_user.language_code = "ru"
        mock_interactor = AsyncMock()
        mock_interactor.return_value = MagicMock(first_name="Иван")

        await command_start_handler(
            message=mock_message,
            interactor=mock_interactor,
            hub=hub,
        )

        mock_message.answer.assert_called_once()
        call_args = mock_message.answer.call_args
        assert call_args.kwargs["text"] == "Привет, Иван!"

    async def test_start_handler_defaults_to_english_for_unknown_language(
        self, mock_message: MagicMock, hub: TranslatorHub
    ) -> None:
        from src.presentation.bot.routers.commands import command_start_handler

        mock_message.from_user.language_code = "de"  # German not supported
        mock_interactor = AsyncMock()
        mock_interactor.return_value = MagicMock(first_name="Hans")

        await command_start_handler(
            message=mock_message,
            interactor=mock_interactor,
            hub=hub,
        )

        mock_message.answer.assert_called_once()
        call_args = mock_message.answer.call_args
        assert call_args.kwargs["text"] == "Hello, Hans!"
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/unit/presentation/bot/routers/test_commands.py -v --no-cov`
Expected: FAIL with TypeError (handler signature mismatch)

**Step 3: Update the handler**

Update `src/presentation/bot/routers/commands.py`:

```python
from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.types import Message
from dishka.integrations.aiogram import FromDishka, inject
from fluentogram import TranslatorHub

from src.application.user.create import CreateUserInputDTO, CreateUserInteractor
from src.infrastructure.i18n import DEFAULT_LANGUAGE, SUPPORTED_LANGUAGES

router = Router(name="commands")


def get_user_locale(language_code: str | None) -> str:
    """Get locale from Telegram language code."""
    if language_code:
        lang = language_code.split("-")[0].lower()
        if lang in SUPPORTED_LANGUAGES:
            return lang
    return DEFAULT_LANGUAGE


@router.message(CommandStart())
@inject
async def command_start_handler(
    message: Message,
    interactor: FromDishka[CreateUserInteractor],
    hub: FromDishka[TranslatorHub],
) -> None:
    """Handle /start command."""
    user = await interactor(
        data=CreateUserInputDTO(
            id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name,
            is_premium=message.from_user.is_premium,
            photo_url=None,
        )
    )

    locale = get_user_locale(message.from_user.language_code)
    i18n = hub.get_translator_by_locale(locale)

    await message.answer(text=i18n.get("welcome", name=user.first_name))
```

**Step 4: Run test to verify it passes**

Run: `pytest tests/unit/presentation/bot/routers/test_commands.py -v --no-cov`
Expected: PASS (3 tests)

**Step 5: Commit**

```bash
git add src/presentation/bot/routers/commands.py tests/unit/presentation/bot/routers/
git commit -m "feat(i18n): localize /start command handler"
```

---

## Task 10: Update /example Admin Handler to Use i18n

**Files:**
- Modify: `src/presentation/bot/routers/admin/example.py`
- Test: `tests/unit/presentation/bot/routers/admin/test_example.py`

**Step 1: Write the failing test**

Create `tests/unit/presentation/bot/routers/admin/__init__.py`:
```python
```

Create `tests/unit/presentation/bot/routers/admin/test_example.py`:

```python
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock

import pytest
from aiogram.types import Message, User
from fluentogram import TranslatorHub

from src.infrastructure.i18n import create_translator_hub


class TestExampleAdminHandler:
    @pytest.fixture
    def hub(self) -> TranslatorHub:
        locales_dir = Path(__file__).parent.parent.parent.parent.parent.parent / "locales"
        return create_translator_hub(locales_dir)

    @pytest.fixture
    def mock_message(self) -> MagicMock:
        message = MagicMock(spec=Message)
        message.from_user = MagicMock(spec=User)
        message.from_user.language_code = "en"
        message.answer = AsyncMock()
        return message

    async def test_example_handler_uses_english(
        self, mock_message: MagicMock, hub: TranslatorHub
    ) -> None:
        from src.presentation.bot.routers.admin.example import example_admin_handler

        await example_admin_handler(message=mock_message, hub=hub)

        mock_message.answer.assert_called_once()
        call_args = mock_message.answer.call_args
        assert call_args.kwargs["text"] == "Example admin command executed"

    async def test_example_handler_uses_russian_for_ru_user(
        self, mock_message: MagicMock, hub: TranslatorHub
    ) -> None:
        from src.presentation.bot.routers.admin.example import example_admin_handler

        mock_message.from_user.language_code = "ru"

        await example_admin_handler(message=mock_message, hub=hub)

        mock_message.answer.assert_called_once()
        call_args = mock_message.answer.call_args
        assert call_args.kwargs["text"] == "Пример админской команды выполнен"
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/unit/presentation/bot/routers/admin/test_example.py -v --no-cov`
Expected: FAIL with TypeError (handler signature mismatch)

**Step 3: Update the handler**

Update `src/presentation/bot/routers/admin/example.py`:

```python
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
from dishka.integrations.aiogram import FromDishka, inject
from fluentogram import TranslatorHub

from src.infrastructure.i18n import DEFAULT_LANGUAGE, SUPPORTED_LANGUAGES

router = Router(name="admin")


def get_user_locale(language_code: str | None) -> str:
    """Get locale from Telegram language code."""
    if language_code:
        lang = language_code.split("-")[0].lower()
        if lang in SUPPORTED_LANGUAGES:
            return lang
    return DEFAULT_LANGUAGE


@router.message(Command("example"))
@inject
async def example_admin_handler(
    message: Message,
    hub: FromDishka[TranslatorHub],
) -> None:
    """Handle /example admin command."""
    locale = get_user_locale(message.from_user.language_code)
    i18n = hub.get_translator_by_locale(locale)

    await message.answer(text=i18n.get("example-executed"))
```

**Step 4: Run test to verify it passes**

Run: `pytest tests/unit/presentation/bot/routers/admin/test_example.py -v --no-cov`
Expected: PASS (2 tests)

**Step 5: Commit**

```bash
git add src/presentation/bot/routers/admin/example.py tests/unit/presentation/bot/routers/admin/
git commit -m "feat(i18n): localize /example admin command handler"
```

---

## Task 11: Extract Locale Helper to Shared Module

**Files:**
- Create: `src/presentation/bot/utils/i18n.py`
- Modify: `src/presentation/bot/routers/commands.py`
- Modify: `src/presentation/bot/routers/admin/example.py`
- Test: `tests/unit/presentation/bot/utils/test_i18n.py`

**Step 1: Create shared utility**

Create `src/presentation/bot/utils/__init__.py`:
```python
```

Create `src/presentation/bot/utils/i18n.py`:

```python
"""i18n utilities for bot handlers."""

from src.infrastructure.i18n import DEFAULT_LANGUAGE, SUPPORTED_LANGUAGES


def get_user_locale(language_code: str | None) -> str:
    """Get locale from Telegram language code.

    Args:
        language_code: Telegram user's language_code (e.g., "en", "ru", "en-US")

    Returns:
        Supported locale code, or DEFAULT_LANGUAGE if not supported.
    """
    if language_code:
        lang = language_code.split("-")[0].lower()
        if lang in SUPPORTED_LANGUAGES:
            return lang
    return DEFAULT_LANGUAGE
```

**Step 2: Write tests for the utility**

Create `tests/unit/presentation/bot/utils/__init__.py`:
```python
```

Create `tests/unit/presentation/bot/utils/test_i18n.py`:

```python
import pytest

from src.presentation.bot.utils.i18n import get_user_locale


class TestGetUserLocale:
    def test_returns_en_for_english(self) -> None:
        assert get_user_locale("en") == "en"

    def test_returns_ru_for_russian(self) -> None:
        assert get_user_locale("ru") == "ru"

    def test_handles_locale_with_region(self) -> None:
        assert get_user_locale("en-US") == "en"
        assert get_user_locale("ru-RU") == "ru"

    def test_returns_default_for_unsupported_language(self) -> None:
        assert get_user_locale("de") == "en"
        assert get_user_locale("fr") == "en"

    def test_returns_default_for_none(self) -> None:
        assert get_user_locale(None) == "en"

    def test_handles_uppercase(self) -> None:
        assert get_user_locale("EN") == "en"
        assert get_user_locale("RU") == "ru"
```

**Step 3: Run tests**

Run: `pytest tests/unit/presentation/bot/utils/test_i18n.py -v --no-cov`
Expected: PASS (6 tests)

**Step 4: Update handlers to use shared utility**

Update `src/presentation/bot/routers/commands.py`:

```python
from aiogram import Router
from aiogram.filters import CommandStart
from aiogram.types import Message
from dishka.integrations.aiogram import FromDishka, inject
from fluentogram import TranslatorHub

from src.application.user.create import CreateUserInputDTO, CreateUserInteractor
from src.presentation.bot.utils.i18n import get_user_locale

router = Router(name="commands")


@router.message(CommandStart())
@inject
async def command_start_handler(
    message: Message,
    interactor: FromDishka[CreateUserInteractor],
    hub: FromDishka[TranslatorHub],
) -> None:
    """Handle /start command."""
    user = await interactor(
        data=CreateUserInputDTO(
            id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name,
            is_premium=message.from_user.is_premium,
            photo_url=None,
        )
    )

    locale = get_user_locale(message.from_user.language_code)
    i18n = hub.get_translator_by_locale(locale)

    await message.answer(text=i18n.get("welcome", name=user.first_name))
```

Update `src/presentation/bot/routers/admin/example.py`:

```python
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
from dishka.integrations.aiogram import FromDishka, inject
from fluentogram import TranslatorHub

from src.presentation.bot.utils.i18n import get_user_locale

router = Router(name="admin")


@router.message(Command("example"))
@inject
async def example_admin_handler(
    message: Message,
    hub: FromDishka[TranslatorHub],
) -> None:
    """Handle /example admin command."""
    locale = get_user_locale(message.from_user.language_code)
    i18n = hub.get_translator_by_locale(locale)

    await message.answer(text=i18n.get("example-executed"))
```

**Step 5: Run all tests**

Run: `pytest tests/unit/presentation/bot/ -v --no-cov`
Expected: PASS (all tests)

**Step 6: Commit**

```bash
git add src/presentation/bot/utils/ src/presentation/bot/routers/ tests/unit/presentation/bot/
git commit -m "refactor(i18n): extract get_user_locale to shared utils"
```

---

## Task 12: Final Verification

**Step 1: Run all unit tests**

Run: `pytest tests/unit/ -v --no-cov`
Expected: All tests pass

**Step 2: Run linter on all new/modified files**

Run: `ruff check src/infrastructure/i18n/ src/presentation/bot/ tests/unit/ --fix`
Expected: No errors

**Step 3: Run formatter**

Run: `ruff format src/infrastructure/i18n/ src/presentation/bot/ tests/unit/`
Expected: Files formatted

**Step 4: Verify stub generation works**

Run: `python scripts/generate_i18n_stubs.py`
Expected: Stubs regenerated successfully

**Step 5: Final commit if any formatting changes**

```bash
git add -A
git status
# If changes exist:
git commit -m "style: apply formatting"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Add dependencies | `pyproject.toml` |
| 2 | English locale files | `locales/en/*.ftl` |
| 3 | Russian locale files | `locales/ru/*.ftl` |
| 4 | i18n hub module | `src/infrastructure/i18n/hub.py` |
| 5 | Dishka provider | `src/infrastructure/i18n/provider.py` |
| 6 | Stub generator | `scripts/generate_i18n_stubs.py` |
| 7 | Register in DI | `src/infrastructure/di/__init__.py` |
| 8 | Bot main integration | `src/presentation/bot/main.py` |
| 9 | /start handler | `src/presentation/bot/routers/commands.py` |
| 10 | /example handler | `src/presentation/bot/routers/admin/example.py` |
| 11 | Extract shared utility | `src/presentation/bot/utils/i18n.py` |
| 12 | Final verification | All files |